# Smart ELCB Dashboard â€” VS Code Setup & Implementation Guide

## Project Structure

```
smart_elcb/
â”œâ”€â”€ arduino/
â”‚   â””â”€â”€ smart_elcb.ino          â† Upload this to Arduino Uno
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ server.js               â† Node.js bridge (Serial â†” WebSocket)
â””â”€â”€ public/
    â””â”€â”€ index.html              â† Web Dashboard (served by Node)
```

---

## Step 1 â€” Install Prerequisites

### 1.1 Install Node.js
Download and install **Node.js v18 LTS** (or newer) from https://nodejs.org

Verify installation:
```bash
node --version    # should print v18.x.x or higher
npm --version
```

### 1.2 Install VS Code Extensions (optional but recommended)
- **Arduino** by Microsoft (for editing `.ino` files)
- **REST Client** by Huachao Mao (for testing `/api/reset`)
- **ESLint** (for JavaScript linting)

---

## Step 2 â€” Upload Arduino Code

1. Open **Arduino IDE** (or use the VS Code Arduino extension).
2. Open `arduino/smart_elcb.ino`.
3. Install required library: **LiquidCrystal I2C** by Frank de Brabander
   - Tools â†’ Manage Libraries â†’ search `LiquidCrystal I2C` â†’ Install
4. Select board: `Arduino Uno`
5. Select the correct **COM port** â€” note this port name (e.g. `COM3` on Windows, `/dev/ttyACM0` on Linux).
6. Click **Upload**.
7. Open Serial Monitor, set baud to **9600**. You should see JSON lines like:
   ```json
   {"type":"data","voltage":10.54,"current":0.123,"fault":false,"tripCurrent":0,"tripTime":0}
   ```
8. **Close** the Serial Monitor â€” Node.js needs exclusive access to the port.

---

## Step 3 â€” Configure the Serial Port in `server.js`

Open `server/server.js` and find line ~17:

```js
const SERIAL_PORT = process.env.SERIAL_PORT || 'COM3';
```

**Change `'COM3'`** to match your Arduino's port:

| OS      | Example value              |
|---------|---------------------------|
| Windows | `'COM3'` or `'COM5'`      |
| macOS   | `'/dev/cu.usbmodem14101'` |
| Linux   | `'/dev/ttyUSB0'` or `'/dev/ttyACM0'` |

To find your port:
- **Windows**: Device Manager â†’ Ports (COM & LPT)
- **macOS/Linux**: `ls /dev/cu.*` or `ls /dev/tty*`

Or run the helper endpoint (after starting the server):
```
GET http://localhost:3000/api/ports
```

---

## Step 4 â€” Install Node Dependencies & Start the Server

Open a terminal in VS Code (`Ctrl + ~`) and run:

```bash
# Navigate to the server folder
cd server

# Install dependencies (express, serialport, ws)
npm install

# Start the server
node server.js
```

You should see:
```
ğŸš€  Dashboard: http://localhost:3000
ğŸ”Œ  Connecting to serial port COM3...
âœ…  Serial connected: COM3 @ 9600
```

If you see a serial port error, double-check Step 3 and make sure the Arduino IDE Serial Monitor is **closed**.

---

## Step 5 â€” Open the Dashboard

Open your browser and go to:
```
http://localhost:3000
```

The dashboard will:
- Connect via WebSocket automatically
- Show "Connected" in the top-right status pill
- Begin displaying live Voltage and Current readings
- Update charts every ~500 ms

---

## Step 6 â€” Test the Fault Simulation

1. Press the **push button** wired to Pin 2 on your Arduino.
2. The relay will cut power (trips OFF).
3. On the dashboard:
   - The **alarm banner** turns red and flashes
   - An **audio alarm** beeps (click anywhere first to unlock audio)
   - The **Trip Current** card updates
   - The event log records the fault time and trip current
   - The LCD replica shows `EARTH LEAKAGE!`

---

## Step 7 â€” Reset the System

**From the dashboard:** Click the **âŸ³ Reset System** button.
- Sends an `'R'` byte over serial to the Arduino
- Arduino re-calibrates and re-energises the relay
- Dashboard updates to "SYSTEM RESTORED" with fault duration logged

**Physical reset:** Press the Arduino hardware reset button â€” the web dashboard will detect the reconnection automatically.

---

## Step 8 â€” Set Your GitHub Link

In the **Project Repository** panel on the dashboard:
1. Paste your GitHub repo URL in the text box, e.g.:
   ```
   https://github.com/YOUR_USERNAME/smart-elcb
   ```
2. Click **UPDATE LINK**
3. The link is saved in `localStorage` and persists across page refreshes

---

## Environment Variable (Optional)

You can set the serial port without editing the file:

```bash
# Windows (PowerShell)
$env:SERIAL_PORT="COM5"; node server.js

# macOS/Linux
SERIAL_PORT=/dev/ttyACM0 node server.js
```

---

## Troubleshooting

| Problem | Solution |
|---------|----------|
| `Error: Access denied (port is busy)` | Close Arduino IDE Serial Monitor |
| `Error: No such file or device` | Wrong port in `server.js` â€” check Step 3 |
| Dashboard shows "Disconnected" | Check Node server is running; refresh browser |
| No audio on fault | Click anywhere on the page first (browser audio policy) |
| Voltage reading is wrong | Verify `VOLTAGE_MULT` constant matches your R1/R2 ratio |
| Current drifts near 0 | Normal â€” ACS712 has ~Â±30 mA noise floor; use averaging |

---

## How the Reset Flow Works

```
Browser click "Reset"
      â”‚
      â–¼
POST /api/reset  (HTTP)
      â”‚
      â–¼
Node.js server
      â”‚  writes 'R' byte
      â–¼
Arduino Serial RX
      â”‚  clears faultState, re-calibrates vzero
      â”‚  digitalWrite(RELAY, ON)
      â–¼
Arduino sends {"type":"reset","status":"ok"}
      â”‚
      â–¼
Node.js WebSocket broadcast
      â”‚
      â–¼
Browser clears alarm, updates LCD, logs restore time
```

---

## Serial JSON Protocol Reference

| Message type | Fields | Direction |
|---|---|---|
| `boot` | `status` | Arduino â†’ Browser |
| `data` | `voltage`, `current`, `fault`, `tripCurrent`, `tripTime` | Arduino â†’ Browser |
| `fault` | `tripCurrent`, `tripTime` | Arduino â†’ Browser |
| `reset` | `status` | Arduino â†’ Browser |
| `serial_status` | `connected`, `error?` | Server â†’ Browser |
| *(raw char)* | `'R'` | Browser â†’ Arduino |
